<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>D3: Empty page template</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  </head>
  <body>
    <div class='container'>
    <div>
      <label for="formFileLg" class="form-label" onchange="loadFile(this)">Input File (history or profile)</label>
      <input class="form-control form-control-lg" id="mesa-input" type="file">

      <div class='my-2' id='plot-area'></div>
    </div>    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script src="d3.js"></script>
    </body>
    <script>
      // const body = d3.select("body");
      // const svg = body.append("svg").attr("width", 500).attr("height", 400);
      // svg
      //   .append("circle")
      //   .attr("cx", 150)
      //   .attr("cy", 75)
      //   .attr("r", 50)
      //   .attr("fill", "blue");
      // svg
      //   .append("circle")
      //   .attr("cx", 300)
      //   .attr("cy", 75)
      //   .attr("r", 50)
      //   .attr("fill", "blue");
      // svg
      //   .append("circle")
      //   .attr("cx", 225)
      //   .attr("cy", 225)
      //   .attr("r", 100)
      // .attr("fill", "red");
      let contents;
      let data;

      async function loadFile(input) {
        let file = input.files[0];
        let fileReader = new FileReader();
        fileReader.readAsText(file);
        fileReader.onload = () => {
          contents = fileReader.result;
          data = process_data(contents);
          // plot_hr()
        }
        fileReader.onerror = () => {
          alert(fileReader.error);
        }
      }
      // async function getFile(files) {
      //   // open file picker
      //   // let [fileHandle] = await window.showOpenFilePicker();
      //   // Note: to select a directory, use showDirectoryPicker
      //   // let fileData = await fileHandle.getFile();
      //   data = process_data(await fileData.text());
      //   return data;
      // }

      // convert MESA output (history or profile) into javascript object
      process_data = (file_contents) => {
        const headerNamesLine = 1;
        const headerValsLine = 2;
        const bulkNamesLine = 5;
        const bulkValsStart = bulkNamesStart + 1;
        let headerData = {};
        let bulkData = [];

        // read file contents into an array
        contents = file_contents.trim();
        lines = contents.trim().split("\n");

        // extract header data
        lines[headerNamesLine]
          .trim()
          .split(/\s+/)
          .forEach((key, i) => {
            headerData[key] = lines[headerValsLine].trim().split(/\s+/)[i].replace(/"/g, "");
          });

        // extract bulk data into a list of objects
        const bulkNames = lines[bulkNamesLine].trim().split(/\s+/);
        lines.slice(bulkValsStart).forEach((line, k) => {
          let line_data = {}
          line
            .trim()
            .split(/\s+/)
            .forEach((datum, i) => {
              line_data[bulkNames[i]] = parseFloat(datum)
            });
          bulkData.push(line_data);
        });

        return { header: headerData, bulk: bulkData };
      };

      function plot_hr() {
        const w = 600
        const h = 400
        const margin = {top:10, right: 30, bottom: 30, left: 60};
        const width = w - margin.left - margin.right;
        const height = h - margin.top - margin.bottom;

        const svg = d3.select('#plot-area')
          .append('svg')
            .attr('height', h)
            .attr('width', w)
          .append('g')
            .attr("transform", `translate(${margin.left}, ${margin.top})`);

        const x = d3.scaleLinear()
          .domain([d3.min(data.bulk.log_Teff), d3.max(data.bulk.log_Teff)])
          .range([width, 0])
        svg.append("g")
          .attr("transform", `translate(0, ${height})`);
          .call(d3.axisBottom(x))

        const y = d3.scaleLinear()
          .domain([d3.min(data.bulk.log_L), d3.max(data.bulk.log_L)])
          .range([height, 0]);
        svg.append("g")
          .call(d3.axisLeft(y));

        svg.append("path")
          .datum
      }

      document.querySelector('#mesa-input').addEventListener('change', (event) => {
        loadFile(event.target);
      });
//       d3.select("#load-data").on('click', (event) => {
//         let files = d3.select('#mesa-input')
//         console.log(files.files)
//         getFile(d3.select('#mesa-input').files[0]).then((result) => {
//
//           data = result;
//         });
//       });
    </script>
  </body>
</html>
